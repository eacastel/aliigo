{
  "version": 3,
  "sources": ["../../../src/widget/v1/aliigo-widget.ts"],
  "sourcesContent": ["// src/widget/v1/aliigo-widget.ts\n\ntype Role = \"user\" | \"assistant\";\ntype Action =\n  | { type: \"link\"; label: string; url: string }\n  | { type: \"handoff\"; label: string; channels?: (\"email\"|\"telegram\"|\"whatsapp\")[] }\n  | { type: \"lead_form\"; fields: (\"name\" | \"email\" | \"phone\")[]; reason?: string };\n\ntype Msg = { role: Role; content: string; actions?: Action[] };\n\ntype Theme = {\n  headerBg?: string;   // \"#111827 #ffffff\"\n  bubbleUser?: string; // \"#2563eb #ffffff\"\n  bubbleBot?: string;  // \"#f3f4f6 #111827\"\n  sendBg?: string;     // \"#2563eb #ffffff\"\n  panelBg?: string;        // \"#09090b\"\n  panelOpacity?: number;   // 0..1\n};\n\ntype SessionPayload = {\n  token: string;\n  locale: \"en\" | \"es\";\n  brand: string;\n  slug: string;\n  theme: Theme | null;\n};\n\ntype WidgetState = {\n  open: boolean;\n  busy: boolean;\n  conversationId: string | null;\n  msgs: Msg[];\n  session: SessionPayload | null;\n  locale: \"en\" | \"es\";\n  visitorSessionId: string | null;\n};\n\ntype ServerAction =\n  | { type: \"cta\"; label: string; url: string }\n  | { type: \"collect_lead\"; fields: (\"name\" | \"email\" | \"phone\")[]; reason?: string };\n\nfunction mapServerActionsToWidget(actions: unknown): Action[] | undefined {\n  if (!Array.isArray(actions)) return undefined;\n\n  const out: Action[] = [];\n\n  for (const a of actions) {\n    if (!a || typeof a !== \"object\") continue;\n    const obj = a as Record<string, unknown>;\n    const t = obj.type;\n\n    if (t === \"cta\") {\n      const label = typeof obj.label === \"string\" ? obj.label : \"\";\n      const url = typeof obj.url === \"string\" ? obj.url : \"\";\n      if (label && url) out.push({ type: \"link\", label, url });\n      continue;\n    }\n\n    if (t === \"collect_lead\") {\n      const fields = Array.isArray(obj.fields)\n        ? obj.fields.filter((f) => f === \"name\" || f === \"email\" || f === \"phone\")\n        : [];\n      const reason = typeof obj.reason === \"string\" ? obj.reason : undefined;\n      out.push({\n        type: \"lead_form\",\n        fields: fields.length ? (fields as (\"name\" | \"email\" | \"phone\")[]) : [\"name\", \"email\"],\n        reason,\n      });\n      continue;\n    }\n  }\n\n  return out.length ? out : undefined;\n}\n\n\nconst UI = {\n  en: {\n    pill: (brand: string) => (brand ? `Ask ${brand}` : \"Chat\"),\n    title: (brand: string) => (brand ? `${brand} Assistant` : \"Assistant\"),\n    welcome: \"Ask a question and we\u2019ll help right away.\",\n    placeholder: \"Type your question\u2026\",\n    send: \"Send\",\n    lead: {\n      title: \"Share your details\",\n      name: \"Name\",\n      email: \"Email\",\n      phone: \"Phone\",\n      submit: \"Send details\",\n      sent: \"Thanks! We\u2019ll be in touch.\",\n      message: \"Here are my contact details.\",\n      hiddenMessage: \"Lead submitted.\",\n      followUp:\n        \"Thanks \u2014 I\u2019ve got your details. Do you have any other questions? I can share pricing, show how the widget works, or help you get set up.\",\n      consent: \"I agree to be contacted about my request.\",\n      consentNote: \"Your information will only be used to follow up on this request.\",\n    },\n  },\n  es: {\n    pill: (brand: string) => (brand ? `Pregunta a ${brand}` : \"Chat\"),\n    title: (brand: string) => (brand ? `Asistente de ${brand}` : \"Asistente\"),\n    welcome: \"Haz tu consulta y te ayudamos al momento.\",\n    placeholder: \"Escribe tu consulta\u2026\",\n    send: \"Enviar\",\n    lead: {\n      title: \"D\u00E9janos tus datos\",\n      name: \"Nombre\",\n      email: \"Email\",\n      phone: \"Tel\u00E9fono\",\n      submit: \"Enviar datos\",\n      sent: \"\u00A1Gracias! Te contactaremos.\",\n      message: \"Aqu\u00ED tienes mis datos de contacto.\",\n      hiddenMessage: \"Datos enviados.\",\n      followUp:\n        \"Gracias \u2014 ya tengo tus datos. \u00BFTienes alguna otra pregunta? Puedo compartir precios, ense\u00F1arte c\u00F3mo funciona el widget o ayudarte a empezar.\",\n      consent: \"Acepto que me contacten sobre mi solicitud.\",\n      consentNote: \"Usaremos estos datos solo para dar seguimiento a tu solicitud.\",\n    },\n  },\n} as const;\n\nfunction isEs(locale: string) {\n  return (locale || \"\").toLowerCase().startsWith(\"es\");\n}\n\nfunction splitPair(v?: string, defaults?: { bg: string; text: string }) {\n  const s = (v || \"\").trim();\n  const m = s.match(/#([0-9a-fA-F]{3}){1,2}/g) || [];\n  const bg = m[0] || defaults?.bg || \"#111827\";\n  const text = m[1] || defaults?.text || \"#ffffff\";\n  return { bg, text };\n}\n\nfunction clamp01(n: number) {\n  return Math.max(0, Math.min(1, n));\n}\n\nfunction hexToRgb(hex: string): { r: number; g: number; b: number } | null {\n  const h = (hex || \"\").trim().replace(\"#\", \"\");\n  if (h.length === 3) {\n    const r = parseInt(h[0] + h[0], 16);\n    const g = parseInt(h[1] + h[1], 16);\n    const b = parseInt(h[2] + h[2], 16);\n    return { r, g, b };\n  }\n  if (h.length === 6) {\n    const r = parseInt(h.slice(0, 2), 16);\n    const g = parseInt(h.slice(2, 4), 16);\n    const b = parseInt(h.slice(4, 6), 16);\n    return { r, g, b };\n  }\n  return null;\n}\n\nfunction rgbaFromHex(hex: string, a: number) {\n  const rgb = hexToRgb(hex);\n  if (!rgb) return null;\n  return `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${clamp01(a)})`;\n}\n\n\nclass AliigoWidget extends HTMLElement {\n  private root!: ShadowRoot;\n\n  private STORAGE_TTL_MS = 30 * 60 * 1000;\n  private STORAGE_PREFIX = \"aliigo_widget_v1\";\n\n  private pendingScroll: \"bottom\" | \"lastAssistantStart\" | null = null;\n\n  // TTL enforcement even without page refresh\n  private expiryTimer: number | null = null;\n  private lastActiveAtMs: number | null = null;\n\n  private lastRenderOpen = false;\n  private pendingFocus = false;\n\n  private sessionHydrated = false;\n  private cachedTheme: Theme | null = null;\n  private cachedBrand = \"\";\n\n  private onFocus = () => this.checkExpiryNow();\n  private onVis = () => {\n    if (!document.hidden) this.checkExpiryNow();\n  };\n\n  private state: WidgetState = {\n    open: false,\n    busy: false,\n    conversationId: null,\n    msgs: [],\n    session: null,\n    locale: \"en\",\n    visitorSessionId: null,\n  };\n\n  static get observedAttributes() {\n    return [\n      \"variant\", \"embed-key\", \"api-base\", \"locale\", \"session-token\",\n      \"floating-mode\", \"theme\", \"brand\",\n      \"start-open\",\n    ];\n  }\n\n  private ensureRoot() {\n    if (!this.shadowRoot) {\n      this.root = this.attachShadow({ mode: \"open\" });\n    } else {\n      this.root = this.shadowRoot;\n    }\n  }\n\n  connectedCallback() {\n    this.ensureRoot();\n    this.state.visitorSessionId = this.getOrCreateVisitorSessionId();\n\n    // restore transcript + conversationId (if within TTL)\n    this.loadPersisted();\n\n    // If we have recent persisted messages, auto-open on refresh (floating only)\n    if (this.getVariant() === \"floating\" && this.state.msgs.length > 0) {\n      this.state.open = true;\n      this.pendingScroll = \"bottom\";\n      this.pendingFocus = true;\n    }\n\n    // If client embed (fixed mode), move to <body> so it's truly viewport-fixed.\n    if (\n      this.getVariant() === \"floating\" &&\n      this.getFloatingMode() === \"fixed\" &&\n      !this.hasAttribute(\"data-no-teleport\")\n    ) {\n      const host = document.body;\n      if (this.parentElement !== host) host.appendChild(this);\n    }\n\n    if (this.getVariant() === \"floating\" && this.getStartOpen()) {\n      this.state.open = true;\n      this.pendingScroll = \"bottom\";\n      this.pendingFocus = true;\n    }\n\n    // Enforce TTL even when the tab stays open\n    window.addEventListener(\"focus\", this.onFocus);\n    document.addEventListener(\"visibilitychange\", this.onVis);\n    this.scheduleExpiryTimer();\n\n    this.sessionHydrated = false;\n    this.render();\n\n    void this.ensureSession().finally(() => {\n      this.sessionHydrated = true;\n      // If ensureSession already rendered an error (no session), don't overwrite it.\n      if (this.state.session || !this.getEmbedKey()) this.render();\n    });\n  }\n\n  disconnectedCallback() {\n    window.removeEventListener(\"focus\", this.onFocus);\n    document.removeEventListener(\"visibilitychange\", this.onVis);\n    this.clearExpiryTimer();\n  }\n\n  attributeChangedCallback(name: string, oldValue: string | null, newValue: string | null) {\n    if (oldValue === newValue) return;\n\n    this.ensureRoot();\n    this.render();\n\n    if (name === \"embed-key\" || name === \"api-base\" || name === \"session-token\") {\n      this.state.session = null;\n\n      // If the identity can change, reset cached skin + hydration\n      if (name === \"embed-key\" || name === \"session-token\") {\n        this.cachedTheme = null;\n        this.cachedBrand = \"\";\n        this.sessionHydrated = false;\n      }\n\n      void this.ensureSession().finally(() => {\n        this.sessionHydrated = true;\n        // Same rule: don't overwrite renderError output.\n        if (this.state.session || !this.getEmbedKey()) this.render();\n      });\n    }\n  }\n\n\n  private clearExpiryTimer() {\n    if (this.expiryTimer != null) {\n      window.clearTimeout(this.expiryTimer);\n      this.expiryTimer = null;\n    }\n  }\n\n  private scheduleExpiryTimer() {\n    this.clearExpiryTimer();\n\n    // Only enforce TTL if we have a conversation transcript to expire\n    if (!this.lastActiveAtMs || this.state.msgs.length === 0) return;\n\n    const msLeft = this.lastActiveAtMs + this.STORAGE_TTL_MS - Date.now();\n    if (msLeft <= 0) {\n      this.expireConversation();\n      return;\n    }\n\n    // Add a tiny buffer so we don't race exact millisecond boundaries\n    this.expiryTimer = window.setTimeout(() => {\n      this.checkExpiryNow();\n    }, msLeft + 50);\n  }\n\n  private checkExpiryNow() {\n    if (!this.lastActiveAtMs || this.state.msgs.length === 0) return;\n\n    const idleMs = Date.now() - this.lastActiveAtMs;\n    if (idleMs >= this.STORAGE_TTL_MS) {\n      this.expireConversation();\n    } else {\n      this.scheduleExpiryTimer();\n    }\n  }\n\n  private expireConversation() {\n    // Clear persisted transcript and reset in-memory conversation\n    this.clearPersisted();\n    this.lastActiveAtMs = null;\n    this.clearExpiryTimer();\n\n    this.state.msgs = [];\n    this.state.conversationId = null;\n    this.state.busy = false;\n\n    // For floating widgets, close on expiry\n    if (this.getVariant() === \"floating\") {\n      this.state.open = false;\n    }\n\n    this.render();\n  }\n\n  private applyPendingScroll() {\n    const messages = this.root.querySelector(\".messages\") as HTMLDivElement | null;\n    if (!messages || !this.pendingScroll) return;\n\n    const mode = this.pendingScroll;\n    this.pendingScroll = null;\n\n    // Snap immediately so you never see \u201Ctop\u201D\n    if (mode === \"bottom\") {\n      messages.scrollTop = messages.scrollHeight;\n    }\n\n    requestAnimationFrame(() => {\n      const max = Math.max(0, messages.scrollHeight - messages.clientHeight);\n\n      if (mode === \"bottom\") {\n        messages.scrollTop = max;\n        return;\n      }\n\n      // lastAssistantStart => jump to last assistant message top (with a little offset)\n      for (let i = this.state.msgs.length - 1; i >= 0; i--) {\n        if (this.state.msgs[i]?.role === \"assistant\") {\n          const el = this.root.querySelector(`#msg-${i}`) as HTMLElement | null;\n          if (!el) return;\n\n          const desired = el.offsetTop - 12;\n          messages.scrollTop = Math.max(0, Math.min(desired, max));\n          return;\n        }\n      }\n    });\n  }\n\n\n  private applyPendingFocus() {\n    if (!this.pendingFocus) return;\n    this.pendingFocus = false;\n\n    requestAnimationFrame(() => {\n      const input = this.root.querySelector(\".input\") as HTMLInputElement | null;\n      input?.focus({ preventScroll: true });\n    });\n  }\n\n\n  private getOrCreateVisitorSessionId() {\n    const k = \"aliigo_visitor_session_v1\";\n    try {\n      const existing = localStorage.getItem(k);\n      if (existing && existing.length >= 24) return existing;\n\n      const rnd = crypto.getRandomValues(new Uint8Array(16));\n      const id = Array.from(rnd).map((b) => b.toString(16).padStart(2, \"0\")).join(\"\");\n      localStorage.setItem(k, id);\n      return id;\n    } catch {\n      // last resort (no storage): per-page random\n      return `${Date.now()}_${Math.random().toString(16).slice(2)}`;\n    }\n  }\n\n  private storageKey() {\n    // embed-key is stable for real embeds; session-token covers dashboard preview\n    const embedKey = this.getEmbedKey();\n    const overrideToken = this.getSessionTokenOverride();\n    const host = (window.location.hostname || \"\").toLowerCase();\n    const key = embedKey || overrideToken || \"no-key\";\n    return `${this.STORAGE_PREFIX}:${key}:${host}`;\n  }\n\n  private loadPersisted() {\n    try {\n      const raw = localStorage.getItem(this.storageKey());\n      if (!raw) return;\n\n      const parsed = JSON.parse(raw) as {\n        savedAt?: number;\n        lastActiveAt?: number;\n        open?: boolean;\n        conversationId?: string | null;\n        msgs?: Msg[];\n        locale?: \"en\" | \"es\";\n        theme?: Theme | null;\n        brand?: string;\n      };\n\n      if (parsed.theme) this.cachedTheme = parsed.theme;\n      if (typeof parsed.brand === \"string\") this.cachedBrand = parsed.brand;\n\n      const lastActive =\n        typeof parsed.lastActiveAt === \"number\"\n          ? parsed.lastActiveAt\n          : typeof parsed.savedAt === \"number\"\n            ? parsed.savedAt\n            : 0;\n\n      if (!lastActive || Date.now() - lastActive > this.STORAGE_TTL_MS) {\n        this.clearPersisted();\n        return;\n      }\n\n      if (typeof parsed.open === \"boolean\") this.state.open = parsed.open;\n      if (Array.isArray(parsed.msgs)) this.state.msgs = parsed.msgs;\n      if (typeof parsed.conversationId === \"string\") this.state.conversationId = parsed.conversationId;\n      if (parsed.locale === \"en\" || parsed.locale === \"es\") this.state.locale = parsed.locale;\n\n      // Track last active for live TTL expiry\n      if (this.state.msgs.length > 0) {\n        this.lastActiveAtMs = lastActive || Date.now();\n      }\n    } catch {\n      // ignore\n    }\n  }\n\n  private savePersisted(touch: boolean = true) {\n    try {\n      const k = this.storageKey();\n      const now = Date.now();\n\n      // Preserve original savedAt if it exists\n      let savedAt = now;\n\n      // Preserve previous lastActiveAt if touch=false\n      let prevLastActiveAt: number | undefined = undefined;\n\n      try {\n        const prevRaw = localStorage.getItem(k);\n        if (prevRaw) {\n          const prev = JSON.parse(prevRaw) as { savedAt?: number; lastActiveAt?: number };\n          if (typeof prev.savedAt === \"number\") savedAt = prev.savedAt;\n          if (typeof prev.lastActiveAt === \"number\") prevLastActiveAt = prev.lastActiveAt;\n        }\n      } catch {\n        // ignore parse issues\n      }\n\n      const nextLastActiveAt = touch ? now : prevLastActiveAt;\n\n      const payload = {\n        savedAt,\n        lastActiveAt: nextLastActiveAt,\n        conversationId: this.state.conversationId,\n        msgs: this.state.msgs,\n        locale: this.state.locale,\n        open: this.state.open,\n        theme: this.cachedTheme,\n        brand: this.cachedBrand,\n      };\n\n      localStorage.setItem(k, JSON.stringify(payload));\n\n      // update live TTL tracking\n      if (this.state.msgs.length > 0) {\n        this.lastActiveAtMs = touch ? now : (nextLastActiveAt ?? this.lastActiveAtMs);\n      } else {\n        this.lastActiveAtMs = null;\n      }\n\n      this.scheduleExpiryTimer();\n    } catch {\n      // ignore storage failures\n    }\n  }\n\n  private clearPersisted() {\n    try {\n      localStorage.removeItem(this.storageKey());\n    } catch {}\n  }\n\n  private getBrandOverride(): string | null {\n    const b = (this.getAttribute(\"brand\") || \"\").trim();\n    return b || null;\n  }\n\n  private getVariant(): \"floating\" | \"inline\" | \"hero\" {\n    const v = (this.getAttribute(\"variant\") || \"floating\").toLowerCase();\n    if (v === \"inline\" || v === \"hero\") return v;\n    return \"floating\";\n  }\n\n  private getEmbedKey() {\n    return (this.getAttribute(\"embed-key\") || \"\").trim();\n  }\n\n  private getApiBase() {\n    return (this.getAttribute(\"api-base\") || \"https://aliigo.com\").trim().replace(/\\/$/, \"\");\n  }\n\n  private getLocaleOverride(): \"en\" | \"es\" | null {\n    const v = (this.getAttribute(\"locale\") || \"\").trim().toLowerCase();\n    if (!v) return null;\n    return v.startsWith(\"es\") ? \"es\" : \"en\";\n  }\n\n  private getSessionTokenOverride(): string | null {\n    const t = (this.getAttribute(\"session-token\") || \"\").trim();\n    return t || null;\n  }\n\n  private getThemeOverride(): Theme | null {\n    const raw = (this.getAttribute(\"theme\") || \"\").trim();\n    if (!raw) return null;\n\n    try {\n      const o = JSON.parse(raw) as Partial<Theme>;\n      const out: Theme = {};\n\n      if (typeof o.headerBg === \"string\") out.headerBg = o.headerBg;\n      if (typeof o.bubbleUser === \"string\") out.bubbleUser = o.bubbleUser;\n      if (typeof o.bubbleBot === \"string\") out.bubbleBot = o.bubbleBot;\n      if (typeof o.sendBg === \"string\") out.sendBg = o.sendBg;\n      if (typeof o.panelBg === \"string\") out.panelBg = o.panelBg;\n      if (typeof o.panelOpacity === \"number\") out.panelOpacity = o.panelOpacity;\n\n\n      return out;\n    } catch {\n      return null;\n    }\n  }\n\n  private getStartOpen(): boolean {\n    return (this.getAttribute(\"start-open\") || \"\").toLowerCase() === \"true\";\n  }\n\n  private getHideHeader(): boolean {\n    return (this.getAttribute(\"hide-header\") || \"\").toLowerCase() === \"true\";\n  }\n\n  private getFloatingMode(): \"fixed\" | \"absolute\" {\n    const v = (this.getAttribute(\"floating-mode\") || \"\").toLowerCase();\n    return v === \"absolute\" ? \"absolute\" : \"fixed\";\n  }\n\n  private async ensureSession(): Promise<SessionPayload | null> {\n    const overrideToken = this.getSessionTokenOverride();\n    const embedKey = this.getEmbedKey();\n    if (!embedKey && !overrideToken) return null;\n\n    // If we already have a session and it's still compatible with overrides, don\u2019t thrash\n    if (this.state.session && !overrideToken) return this.state.session;\n\n    try {\n      const apiBase = this.getApiBase();\n\n      if (overrideToken) {\n        const localeOverride = this.getLocaleOverride();\n        const themeOverride = this.getThemeOverride();\n        const brandOverride = this.getBrandOverride();\n\n        this.state.session = {\n          token: overrideToken,\n          locale: localeOverride || this.state.locale,\n          brand: (brandOverride || \"\").trim(),\n          slug: \"\",\n          theme: themeOverride,\n        };\n\n        this.cachedTheme = this.state.session.theme || null;\n        this.cachedBrand = this.state.session.brand || \"\";\n        this.state.locale = localeOverride || this.state.locale;\n        this.savePersisted(false);\n        this.render();\n        return this.state.session;\n      }\n\n      const url = new URL(`${apiBase}/api/embed/session`);\n      url.searchParams.set(\"key\", embedKey);\n      url.searchParams.set(\"host\", window.location.hostname);\n\n      const res = await fetch(url.toString(), { method: \"GET\" });\n      const data = (await res.json().catch(() => ({}))) as Partial<SessionPayload> & { error?: string };\n\n      if (!res.ok || !data.token) {\n        this.state.session = null;\n        this.renderError(data.error || \"Session error\");\n        return null;\n      }\n\n      const localeOverride = this.getLocaleOverride();\n      const locale = localeOverride || (isEs(data.locale || \"en\") ? \"es\" : \"en\");\n\n      this.state.session = {\n        token: data.token,\n        locale,\n        brand: (data.brand || \"\").trim(),\n        slug: (data.slug || \"\").trim(),\n        theme: (data.theme as Theme | null) || null,\n      };\n\n      this.cachedTheme = this.state.session.theme || null;\n      this.cachedBrand = this.state.session.brand || \"\";\n      this.state.locale = locale;\n      this.savePersisted(false);\n      this.render();\n      return this.state.session;\n    } catch {\n      this.renderError(\"Network error\");\n      return null;\n    }\n  }\n\n  private async tryRefreshSessionToken(): Promise<string | null> {\n    this.state.session = null;\n    const s = await this.ensureSession();\n    return s?.token ?? null;\n  }\n\n  private async refreshSessionIfStale() {\n    // Enforce chat TTL before sending\n    this.checkExpiryNow();\n\n    const idleMs = this.lastActiveAtMs ? Date.now() - this.lastActiveAtMs : 0;\n    const refreshThresholdMs = 25 * 60 * 1000;\n\n    if (idleMs >= refreshThresholdMs || !this.state.session?.token) {\n      await this.tryRefreshSessionToken();\n    }\n  }\n\n  private renderError(msg: string) {\n    this.ensureRoot();\n    this.root.innerHTML = `\n      <style>${this.css()}</style>\n      <div class=\"wrap inline\">\n        <div class=\"panel\">\n          <div class=\"header\">Aliigo</div>\n          <div class=\"body\"><div class=\"bubble bot\">${msg}</div></div>\n        </div>\n      </div>\n    `;\n  }\n\n  private css() {\n    return `\n      :host { all: initial; display: block; }\n      :host([floating-mode=\"absolute\"]) { position: relative; width: 100%; height: 100%; display: block; }\n\n      .wrap {\n        font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, Helvetica, Arial, sans-serif, \"Apple Color Emoji\", \"Segoe UI Emoji\";\n        box-sizing: border-box;\n        -webkit-font-smoothing: antialiased;\n      }\n      .wrap * { box-sizing: border-box; }\n\n      /* --- Positioning --- */\n      .floating.fixed {\n        position: fixed;\n        right: 20px;\n        bottom: 20px;\n        z-index: 99999;\n      }\n      @media (max-width: 640px) {\n        .floating.fixed {\n          right: 16px;\n          left: auto;\n          bottom: 16px;\n        }\n      }\n      .floating.absolute {\n        position: absolute;\n        inset: 0;\n        z-index: 99999;\n        display: flex;\n        justify-content: flex-end;\n        align-items: flex-end;\n        padding: 20px;\n      }\n      .floating.absolute .panel {\n        max-width: 100%;\n        max-height: 100%;\n      }\n      .inline { width: 100%; }\n      .hero { width: 100%; height: 100%; max-width: 100%; margin: 0 auto; }\n\n      /* --- Pill (Launcher) --- */\n      .pill {\n        border: 0; cursor: pointer; font-weight: 600;\n        border-radius: 99px; padding: 14px 24px;\n        box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n        transition: transform 0.2s ease, box-shadow 0.2s ease;\n        font-size: 15px;\n        display: flex; align-items: center; gap: 8px;\n      }\n      .pill:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.2); }\n      .pill:active { transform: translateY(0); }\n\n      /* --- Main Panel --- */\n      .panel {\n        width: 380px;\n        height: 600px;\n        max-height: 80vh;\n\n        background: var(--panel-bg, #ffffff); /* NEW */\n        border: 1px solid rgba(0,0,0,0.06);\n        border-radius: 16px;\n        overflow: hidden;\n        box-shadow: 0 8px 32px rgba(0,0,0,0.12);\n        display: flex;\n        flex-direction: column;\n      }\n\n      .panel.animate-in {\n      animation: panel-enter 0.3s cubic-bezier(0.16, 1, 0.3, 1);\n      }\n\n      .panel.inline { width: 100%; max-width: 100%; height: 500px; box-shadow: none; border: 1px solid #e5e7eb; }\n      .panel.hero { width: 100%; max-width: 100%; height: 100%; box-shadow: none; border: none; border-radius: 0; }\n      .panel.no-header .messages { padding-top: 24px; }\n\n      /* --- Header --- */\n      .header {\n        padding: 16px 20px;\n        display: flex; align-items: center; justify-content: space-between;\n        border-bottom: 1px solid rgba(0,0,0,0.05);\n        font-weight: 600;\n        font-size: 16px;\n        letter-spacing: -0.01em;\n      }\n      .close {\n        border: 0; background: transparent; cursor: pointer;\n        font-size: 24px; line-height: 1; opacity: 0.6;\n        padding: 4px; margin: -4px;\n        transition: opacity 0.2s;\n      }\n      .close:hover { opacity: 1; }\n\n      /* --- Body & Messages --- */\n      .body {\n        flex: 1;\n        min-height: 0;\n        position: relative;\n        background: transparent; /* NEW */\n      }\n      .messages {\n        height: 100%;\n        overflow-y: auto;\n        overflow-x: hidden;\n        padding: 20px;\n      }\n\n      .row {\n        margin-top: 12px;\n        display: flex;\n        width: 100%;\n      }\n      .row.user { justify-content: flex-end; }\n      .row.bot { justify-content: flex-start; }\n\n      /* --- Bubbles --- */\n      .bubble {\n        display: block;\n        position: relative;\n        max-width: 85%;\n        padding: 10px 16px;\n        border-radius: 18px;\n        font-size: 15px;\n        line-height: 1.5;\n        word-wrap: break-word;\n        white-space: normal;\n        box-shadow: 0 1px 2px rgba(0,0,0,0.04);\n        transform-origin: bottom center;\n      }\n\n      .bubble.anim {\n        animation: message-enter 0.3s cubic-bezier(0.25, 1, 0.5, 1) forwards;\n      }\n\n      .bubble.user {\n        border-bottom-right-radius: 4px;\n        margin-left: 40px;\n      }\n\n      .bubble.bot {\n        border-bottom-left-radius: 4px;\n        margin-right: 40px;\n        border: 1px solid rgba(0,0,0,0.04);\n      }\n\n      .bubble strong { font-weight: 600; }\n      .bubble .list { margin: 8px 0 0 0; padding-left: 18px; }\n      .bubble .list li { margin: 4px 0; }\n\n      /* --- Input Area --- */\n      .form {\n        flex: 0 0 auto;\n        display: flex;\n        gap: 10px;\n        padding: 16px;\n        border-top: 1px solid rgba(0,0,0,0.06);\n        background: rgba(255,255,255,0.06);\n        backdrop-filter: blur(6px);\n      }\n\n      /* --- Actions (buttons/links under assistant messages) --- */\n      .actions { margin-top: 8px; display:flex; flex-wrap:wrap; gap:8px; }\n      .action, .action-btn {\n        display:inline-flex; align-items:center; justify-content:center;\n        padding:10px 12px; border-radius:12px; font-weight:600; font-size:14px;\n        border:1px solid rgba(0,0,0,0.10); background:#fff; color:#111827;\n        text-decoration:none; cursor:pointer;\n      }\n      .action:hover, .action-btn:hover { border-color: rgba(0,0,0,0.18); }\n\n      .lead-form {\n        margin-top: 8px;\n        display: grid;\n        gap: 8px;\n        padding: 10px;\n        border-radius: 12px;\n        border: 1px solid rgba(0,0,0,0.08);\n        background: rgba(255,255,255,0.75);\n      }\n      .lead-form .lead-reason { font-size: 13px; color:#374151; }\n      .lead-field { display: grid; gap: 4px; }\n      .lead-label { font-size: 12px; color:#6b7280; }\n      .lead-input {\n        height: 36px;\n        border: 1px solid #e5e7eb;\n        background: #ffffff;\n        border-radius: 10px;\n        padding: 0 10px;\n        font-size: 14px;\n        color: #111827;\n        outline: none;\n      }\n      .lead-input:focus { border-color:#d1d5db; box-shadow: 0 0 0 3px rgba(0,0,0,0.05); }\n      .lead-submit {\n        height: 36px;\n        border: 0;\n        border-radius: 10px;\n        font-size: 13px;\n        font-weight: 600;\n        cursor: pointer;\n        background: #111827;\n        color: #ffffff;\n      }\n      .lead-consent {\n        display: flex;\n        gap: 8px;\n        align-items: flex-start;\n        font-size: 12px;\n        color: #374151;\n      }\n      .lead-consent input {\n        margin-top: 2px;\n      }\n      .lead-consent-note {\n        font-size: 11px;\n        color: #6b7280;\n        margin-top: -2px;\n      }\n      .lead-form.sent .lead-input,\n      .lead-form.sent .lead-submit {\n        opacity: 0.6;\n        pointer-events: none;\n      }\n\n\n      .input {\n        flex: 1;\n        height: 44px;\n        border: 1px solid #e5e7eb;\n        background: #f9fafb;\n        border-radius: 22px;\n        padding: 0 16px;\n        font-size: 15px;\n        outline: none;\n        transition: all 0.2s ease;\n        color: #111827;\n      }\n      .input:focus {\n        background: #ffffff;\n        border-color: #d1d5db;\n        box-shadow: 0 0 0 3px rgba(0,0,0,0.05);\n      }\n      .input::placeholder { color: #9ca3af; }\n\n      .send {\n        height: 44px;\n        padding: 0 20px;\n        border: 0;\n        border-radius: 22px;\n        font-size: 15px;\n        font-weight: 600;\n        cursor: pointer;\n        flex-shrink: 0;\n        transition: transform 0.1s ease, opacity 0.2s;\n      }\n      .send:active { transform: scale(0.96); }\n      .send:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }\n\n      @keyframes message-enter {\n        0% { opacity: 0; transform: translateY(10px) scale(0.98); }\n        100% { opacity: 1; transform: translateY(0) scale(1); }\n      }\n      @keyframes panel-enter {\n        0% { opacity: 0; transform: translateY(20px) scale(0.96); }\n        100% { opacity: 1; transform: translateY(0) scale(1); }\n      }\n\n      @media (max-width: 480px) {\n      .floating.fixed { left: 0; right: 0; bottom: 0; }\n\n      /* Only go fullscreen if explicitly enabled */\n      :host([mobile-fullscreen=\"true\"]) .floating.fixed .panel {\n        width: 100%;\n        height: 100%;\n        max-height: 100%;\n        border-radius: 0;\n      }\n    }\n    `;\n  }\n\n  private render() {\n    this.ensureRoot();\n    const variant = this.getVariant();\n\n    \n\n\n    const needsRemoteTheme =\n      !!this.getEmbedKey() &&\n      !this.getThemeOverride() &&\n      !this.cachedTheme &&\n      !this.state.session?.theme;\n      if (needsRemoteTheme && !this.sessionHydrated) {\n        // prevent \u201Cstock \u2192 client\u201D flash on first paint\n        // keep space for inline/hero to avoid layout jump\n        const wrapperClass =\n          variant === \"floating\"\n            ? `wrap floating ${this.getFloatingMode()}`\n            : variant === \"hero\"\n              ? \"wrap hero\"\n              : \"wrap inline\";\n\n        const placeholderPanel =\n          variant === \"hero\" ? \"panel hero\" : variant === \"inline\" ? \"panel inline\" : \"panel\";\n\n        this.root.innerHTML = `\n          <style>${this.css()}</style>\n          <div class=\"${wrapperClass}\">\n            <div class=\"${placeholderPanel}\" style=\"visibility:hidden\"></div>\n          </div>\n        `;\n        return;\n      }\n\n\n    const session = this.state.session;\n    const locale = this.getLocaleOverride() || this.state.locale;\n    const t = UI[locale];\n\n\n    const theme = this.getThemeOverride() || session?.theme || this.cachedTheme || {};\n\n    const panelHex = (theme.panelBg || \"\").trim();\n    const panelOpacity =\n      typeof theme.panelOpacity === \"number\" ? clamp01(theme.panelOpacity) : 1;\n\n    const panelRgba = panelHex ? rgbaFromHex(panelHex, panelOpacity) : null;\n\n\n    const panelStyle = panelRgba ? `style=\"--panel-bg:${panelRgba};\"` : \"\";\n\n\n    const brand = (this.getBrandOverride() || session?.brand || this.cachedBrand || \"\").trim();\n\n    const header = splitPair(theme.headerBg, { bg: \"#111827\", text: \"#ffffff\" });\n    const user = splitPair(theme.bubbleUser, { bg: \"#2563eb\", text: \"#ffffff\" });\n    const bot = splitPair(theme.bubbleBot, { bg: \"#f3f4f6\", text: \"#111827\" });\n    const send = splitPair(theme.sendBg, { bg: \"#2563eb\", text: \"#ffffff\" });\n    const hideHeader = this.getHideHeader();\n\n    const open = variant !== \"floating\" ? true : this.state.open;\n\n    const openNow = open;\n    const animateIn = openNow && !this.lastRenderOpen;\n    this.lastRenderOpen = openNow;\n\n    const floatingMode = this.getFloatingMode();\n    const wrapperClass =\n      variant === \"floating\"\n        ? `wrap floating ${floatingMode}`\n        : variant === \"hero\"\n          ? \"wrap hero\"\n          : \"wrap inline\";\n\n    const basePanelClass =\n      variant === \"hero\" ? \"panel hero\" : variant === \"inline\" ? \"panel inline\" : \"panel\";\n\n    const panelClass = animateIn ? `${basePanelClass} animate-in` : basePanelClass;\n    const panelClassWithHeader = hideHeader ? `${panelClass} no-header` : panelClass;\n\n\n    const msgs = this.state.msgs;\n    const messagesHtml =\n      msgs.length === 0\n        ? `<div class=\"row bot\" id=\"msg-0\">\n            <div class=\"bubble bot anim\" style=\"--bg:${bot.bg};--fg:${bot.text};background:var(--bg);color:var(--fg);\">\n              ${t.welcome}\n            </div>\n          </div>`\n        : msgs\n            .map((m, i) => {\n              const isUser = m.role === \"user\";\n              const isLast = i === msgs.length - 1;\n              const bubbleStyle = isUser\n                ? `--bg:${user.bg};--fg:${user.text};background:var(--bg);color:var(--fg);`\n                : `--bg:${bot.bg};--fg:${bot.text};background:var(--bg);color:var(--fg);`;\n\n              return `<div class=\"row ${isUser ? \"user\" : \"bot\"}\" id=\"msg-${i}\">\n                <div class=\"bubble ${isUser ? \"user\" : \"bot\"} ${isLast ? \"anim\" : \"\"}\" style=\"${bubbleStyle}\">\n                  ${formatMessageHtml(m.content)}\n                  ${\n                    !isUser && Array.isArray(m.actions) && m.actions.length\n                      ? `<div class=\"actions\">\n                          ${m.actions\n                            .map((a) => {\n                              if (a.type === \"link\") {\n                                return `<a class=\"action\" href=\"${escapeHtml(a.url)}\" target=\"_blank\" rel=\"noopener noreferrer\">${escapeHtml(a.label)}</a>`;\n                              }\n                              if (a.type === \"handoff\") {\n                                return `<button class=\"action-btn\" type=\"button\" data-action=\"handoff\" data-i=\"${i}\">${escapeHtml(a.label)}</button>`;\n                              }\n                              if (a.type === \"lead_form\") {\n                                const fields = Array.isArray(a.fields) ? a.fields : [\"name\", \"email\"];\n                                const reason = a.reason ? `<div class=\"lead-reason\">${escapeHtml(a.reason)}</div>` : \"\";\n                                const rows = fields\n                                  .map((f) => {\n                                    const label =\n                                      f === \"name\" ? t.lead.name : f === \"phone\" ? t.lead.phone : t.lead.email;\n                                    const type = f === \"email\" ? \"email\" : f === \"phone\" ? \"tel\" : \"text\";\n                                    return `<label class=\"lead-field\">\n                                      <span class=\"lead-label\">${escapeHtml(label)}</span>\n                                      <input class=\"lead-input\" name=\"${f}\" type=\"${type}\" required />\n                                    </label>`;\n                                  })\n                                  .join(\"\");\n                                const consent = `<label class=\"lead-consent\">\n                                  <input type=\"checkbox\" name=\"consent\" required />\n                                  <span>${escapeHtml(t.lead.consent)}</span>\n                                </label>\n                                <div class=\"lead-consent-note\">${escapeHtml(t.lead.consentNote)}</div>`;\n                                return `<form class=\"lead-form\" data-action=\"lead-form\" data-i=\"${i}\">\n                                  ${reason}\n                                  ${rows}\n                                  ${consent}\n                                  <button class=\"lead-submit\" type=\"submit\">${escapeHtml(t.lead.submit)}</button>\n                                </form>`;\n                              }\n                              return \"\";\n                            })\n                            .join(\"\")}\n                        </div>`\n                      : \"\"\n                  }\n                </div>\n              </div>`;\n            })\n            .join(\"\");\n            \n\n    // floating closed => pill only\n    if (variant === \"floating\" && !open) {\n      this.lastRenderOpen = false;\n      const hasToken = !!session?.token || !!this.getSessionTokenOverride();\n      if (!hasToken) {\n        this.root.innerHTML = `<style>${this.css()}</style>`;\n        return;\n      }\n\n      this.root.innerHTML = `\n        <style>${this.css()}</style>\n        <div class=\"${wrapperClass}\">\n          <button class=\"pill\" style=\"background:${send.bg};color:${send.text};\">${t.pill(brand)}</button>\n        </div>\n      `;\n      this.root\n        .querySelectorAll(\".action-btn[data-action='handoff']\")\n        .forEach((btn) => {\n          btn.addEventListener(\"click\", () => {\n            // Temporary: send a message that triggers your server\u2019s lead-intent flow\n            void this.send(\"I\u2019d like a human follow-up.\");\n          });\n        });\n\n      const btn = this.root.querySelector(\".pill\") as HTMLButtonElement | null;\n      btn?.addEventListener(\"click\", () => {\n        this.state.open = true;\n        this.pendingFocus = true;\n        this.savePersisted(false);\n        this.pendingScroll = \"bottom\";\n        this.render();\n      });\n\n      return;\n    }\n\n    this.root.innerHTML = `\n      <style>${this.css()}</style>\n      <div class=\"${wrapperClass}\">\n      <div class=\"${panelClassWithHeader}\" ${panelStyle}>\n          ${\n            hideHeader\n              ? \"\"\n              : `<div class=\"header\" style=\"background:${header.bg};color:${header.text};\">\n            <div>${t.title(brand)}</div>\n            ${variant === \"floating\" ? `<button class=\"close\" aria-label=\"Close\" style=\"color:${header.text};\">\u00D7</button>` : ``}\n          </div>`\n          }\n\n          <div class=\"body\">\n            <div class=\"messages\">${messagesHtml}<div id=\"bottom\"></div></div>\n          </div>\n\n          <form class=\"form\">\n            <input class=\"input\" placeholder=\"${t.placeholder}\" />\n            <button class=\"send\" type=\"submit\" style=\"background:${send.bg};color:${send.text};\" ${this.state.busy || !session?.token ? \"disabled\" : \"\"}>${t.send}</button>\n          </form>\n        </div>\n      </div>\n    `;\n\n    const close = this.root.querySelector(\".close\") as HTMLButtonElement | null;\n    close?.addEventListener(\"click\", () => {\n      this.state.open = false;\n      this.savePersisted(false);\n      this.render();\n    });\n\n    const form = this.root.querySelector(\".form\") as HTMLFormElement | null;\n    const input = this.root.querySelector(\".input\") as HTMLInputElement | null;\n\n    form?.addEventListener(\"submit\", (e) => {\n      e.preventDefault();\n      const v = (input?.value || \"\").trim();\n      if (!v) return;\n      if (input) input.value = \"\";\n      this.pendingFocus = true;\n      void this.send(v);\n    });\n\n    this.root.querySelectorAll(\".lead-form\").forEach((el) => {\n      const formEl = el as HTMLFormElement;\n      formEl.addEventListener(\"submit\", (e) => {\n        e.preventDefault();\n        const fd = new FormData(formEl);\n        const lead = {\n          name: (fd.get(\"name\") || \"\").toString().trim(),\n          email: (fd.get(\"email\") || \"\").toString().trim(),\n          phone: (fd.get(\"phone\") || \"\").toString().trim(),\n          consent: (fd.get(\"consent\") || \"\") === \"on\",\n        };\n\n        if (!lead.name && !lead.email && !lead.phone) return;\n        if (!lead.consent) return;\n\n        formEl.classList.add(\"sent\");\n        const btn = formEl.querySelector(\".lead-submit\") as HTMLButtonElement | null;\n        if (btn) btn.textContent = t.lead.sent;\n\n        const messageIndex = Number(formEl.dataset.i || \"\");\n        if (!Number.isNaN(messageIndex)) {\n          const msg = this.state.msgs[messageIndex];\n          if (msg?.actions?.length) {\n            msg.actions = msg.actions.filter((a) => a.type !== \"lead_form\");\n          }\n          // Remove the assistant bubble that asked for details to avoid duplication\n          const nextMsgs = this.state.msgs.slice();\n          nextMsgs.splice(messageIndex, 1);\n          this.state.msgs = nextMsgs;\n          this.pendingScroll = \"bottom\";\n          this.render();\n        }\n\n        void this.send(t.lead.hiddenMessage, lead, t.lead.followUp, {\n          silentUser: true,\n          suppressReply: true,\n        });\n      });\n    });\n\n    this.applyPendingScroll();\n    this.applyPendingFocus();\n  }\n\n  private async send(\n    content: string,\n    lead?: { name?: string; email?: string; phone?: string; consent?: boolean },\n    postReply?: string,\n    opts?: { silentUser?: boolean; suppressReply?: boolean }\n  ) {\n    await this.refreshSessionIfStale();\n    const session = this.state.session;\n    if (!session?.token) return;\n\n    this.state.busy = true;\n    if (!opts?.silentUser) {\n      this.state.msgs = [...this.state.msgs, { role: \"user\", content }];\n    }\n    this.pendingFocus = true;\n    this.savePersisted(true);\n    this.pendingScroll = \"bottom\";\n    this.render();\n\n    try {\n      const apiBase = this.getApiBase();\n      const res = await fetch(`${apiBase}/api/conversation`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify({\n            token: session.token,\n            conversationId: this.state.conversationId,\n            externalRef: this.state.visitorSessionId,\n            message: content,\n            locale: this.state.locale,\n            channel: \"web\",\n            ...(lead ? { lead } : {}),\n          }),\n        });\n\n      const raw = (await res.json().catch(() => ({}))) as {\n        conversationId?: string;\n        reply?: string;\n        actions?: unknown;\n        error?: string;\n        locale?: string;\n      };\n\n      if (!res.ok) {\n        const errText = (raw.error || \"\").toLowerCase();\n        const shouldRefresh = res.status === 401 || res.status === 403;\n        const isExpired = errText.includes(\"session expired\");\n\n        // Auto-recover from auth/session errors once (refresh token, retry)\n        if (shouldRefresh) {\n          const fresh = await this.tryRefreshSessionToken();\n\n          if (fresh) {\n            const retry = await fetch(`${apiBase}/api/conversation`, {\n              method: \"POST\",\n              headers: { \"Content-Type\": \"application/json\" },\n              body: JSON.stringify({\n                token: fresh,\n                conversationId: this.state.conversationId,\n                externalRef: this.state.visitorSessionId,\n                message: content,\n                locale: this.state.locale,\n                channel: \"web\",\n                ...(lead ? { lead } : {}),\n              }),\n            });\n\n            const raw2 = (await retry.json().catch(() => ({}))) as {\n              conversationId?: string;\n              reply?: string;\n              error?: string;\n              locale?: string;\n              actions?: unknown;\n            };\n\n            if (retry.ok) {\n              if (raw2.conversationId) this.state.conversationId = raw2.conversationId;\n              const nextActions2 = mapServerActionsToWidget(raw2.actions);\n              const cleanedActions2 = lead\n                ? nextActions2?.filter((a) => a.type !== \"lead_form\")\n                : nextActions2;\n\n              if (!opts?.suppressReply) {\n                this.state.msgs = [\n                  ...this.state.msgs,\n                  { role: \"assistant\", content: raw2.reply || \"\", actions: cleanedActions2 },\n                ];\n              }\n              if (postReply) {\n                this.state.msgs = [\n                  ...this.state.msgs,\n                  { role: \"assistant\", content: postReply },\n                ];\n              }\n              this.pendingFocus = true;\n              this.state.busy = false;\n              this.savePersisted(true);\n              this.pendingScroll = \"lastAssistantStart\";\n              this.render();\n              return;\n            }\n\n            // retry failed\n            const friendly =\n              (raw2.error || \"\").toLowerCase().includes(\"session expired\")\n                ? \"Session refreshed. Please try again.\"\n                : (raw2.error || \"Error\");\n            this.state.msgs = [...this.state.msgs, { role: \"assistant\", content: friendly }];\n            this.pendingFocus = true;\n            this.state.busy = false;\n            this.savePersisted(true);\n            this.pendingScroll = \"lastAssistantStart\";\n            this.render();\n            return;\n          }\n        }\n\n        // default error path\n        const friendly =\n          isExpired ? \"Session refreshed. Please try again.\" : (raw.error || \"Error\");\n        this.state.msgs = [...this.state.msgs, { role: \"assistant\", content: friendly }];\n        this.pendingFocus = true;\n        this.state.busy = false;\n        this.savePersisted(true);\n        this.pendingScroll = \"lastAssistantStart\";\n        this.render();\n        return;\n      }\n\n      if (raw.conversationId) this.state.conversationId = raw.conversationId;\n      const nextActions = mapServerActionsToWidget(raw.actions);\n      const cleanedActions = lead\n        ? nextActions?.filter((a) => a.type !== \"lead_form\")\n        : nextActions;\n      if (!opts?.suppressReply) {\n        this.state.msgs = [\n          ...this.state.msgs,\n          { role: \"assistant\", content: raw.reply || \"\", actions: cleanedActions },\n        ];\n      }\n      if (postReply) {\n        this.state.msgs = [\n          ...this.state.msgs,\n          { role: \"assistant\", content: postReply },\n        ];\n      }\n      this.pendingFocus = true;\n      this.state.busy = false;\n      this.savePersisted(true);\n      this.pendingScroll = \"lastAssistantStart\";\n      this.render();\n    } catch {\n      this.state.msgs = [...this.state.msgs, { role: \"assistant\", content: \"Network error\" }];\n      this.pendingFocus = true;\n      this.pendingScroll = \"lastAssistantStart\";\n      this.state.busy = false;\n      this.savePersisted(true);\n      this.render();\n    }\n  }\n}\n\nfunction escapeHtml(s: string) {\n  return (s || \"\")\n    .replaceAll(\"&\", \"&amp;\")\n    .replaceAll(\"<\", \"&lt;\")\n    .replaceAll(\">\", \"&gt;\")\n    .replaceAll('\"', \"&quot;\")\n    .replaceAll(\"'\", \"&#039;\");\n}\n\nfunction linkify(escaped: string) {\n  // escaped is already HTML-escaped, so safe to inject our own <a>\n  // Matches http(s) URLs\n  return escaped.replace(\n    /(https?:\\/\\/[^\\s<]+[^<.,:;\"')\\]\\s])/g,\n    `<a href=\"$1\" target=\"_blank\" rel=\"noopener noreferrer\">$1</a>`\n  );\n}\n\nfunction formatMessageHtml(raw: string) {\n  const escaped = escapeHtml(raw || \"\");\n  const escapedWithLinks = linkify(escaped);\n  const lines = escapedWithLinks.split(/\\r?\\n/);\n\n  const inline = (s: string) =>\n    s.replace(/\\*\\*(.+?)\\*\\*/g, \"<strong>$1</strong>\");\n\n  const joinLines = (arr: string[]) => inline(arr.join(\"<br/>\"));\n\n  // ---------- Numbered list ----------\n  const firstNumIdx = lines.findIndex((l) => /^\\s*\\d+\\.\\s+/.test(l));\n  if (firstNumIdx !== -1) {\n    const leadLines = lines.slice(0, firstNumIdx).filter((l) => l.trim() !== \"\");\n\n    const items: string[] = [];\n    const tailLines: string[] = [];\n\n    for (let i = firstNumIdx; i < lines.length; i++) {\n      const l = lines[i] ?? \"\";\n      if (/^\\s*\\d+\\.\\s+/.test(l)) {\n        items.push(l.replace(/^\\s*\\d+\\.\\s+/, \"\").trim());\n        continue;\n      }\n      if (l.trim() === \"\") continue;\n      tailLines.push(l);\n    }\n\n    if (items.length === 0) return joinLines(lines);\n\n    return `\n      ${leadLines.length ? `<div class=\"lead\">${joinLines(leadLines)}</div>` : \"\"}\n      <ol class=\"list\">\n        ${items.map((it) => `<li>${inline(it)}</li>`).join(\"\")}\n      </ol>\n      ${tailLines.length ? `<div class=\"tail\">${joinLines(tailLines)}</div>` : \"\"}\n    `;\n  }\n\n  // ---------- Bulleted list ----------\n  const firstBulIdx = lines.findIndex((l) => /^\\s*[-\u2022]\\s+/.test(l));\n  if (firstBulIdx !== -1) {\n    const leadLines = lines.slice(0, firstBulIdx).filter((l) => l.trim() !== \"\");\n\n    const items: string[] = [];\n    const tailLines: string[] = [];\n\n    for (let i = firstBulIdx; i < lines.length; i++) {\n      const l = lines[i] ?? \"\";\n      if (/^\\s*[-\u2022]\\s+/.test(l)) {\n        items.push(l.replace(/^\\s*[-\u2022]\\s+/, \"\").trim());\n        continue;\n      }\n      if (l.trim() === \"\") continue;\n      tailLines.push(l);\n    }\n\n    if (items.length === 0) return joinLines(lines);\n\n    return `\n      ${leadLines.length ? `<div class=\"lead\">${joinLines(leadLines)}</div>` : \"\"}\n      <ul class=\"list\">\n        ${items.map((it) => `<li>${inline(it)}</li>`).join(\"\")}\n      </ul>\n      ${tailLines.length ? `<div class=\"tail\">${joinLines(tailLines)}</div>` : \"\"}\n    `;\n  }\n\n  // ---------- Fallback ----------\n  return joinLines(lines);\n}\n\nif (!customElements.get(\"aliigo-widget\")) {\n  customElements.define(\"aliigo-widget\", AliigoWidget);\n}\n"],
  "mappings": "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",
  "names": ["mapServerActionsToWidget", "actions", "out", "a", "obj", "t", "label", "url", "fields", "f", "reason", "UI", "brand", "isEs", "locale", "splitPair", "v", "defaults", "m", "bg", "text", "clamp01", "n", "hexToRgb", "hex", "h", "r", "g", "b", "rgbaFromHex", "rgb", "AliigoWidget", "host", "name", "oldValue", "newValue", "msLeft", "messages", "mode", "_a", "max", "i", "el", "desired", "input", "k", "existing", "rnd", "id", "embedKey", "overrideToken", "key", "raw", "parsed", "lastActive", "touch", "now", "savedAt", "prevLastActiveAt", "prevRaw", "prev", "nextLastActiveAt", "payload", "o", "apiBase", "localeOverride", "themeOverride", "brandOverride", "res", "data", "s", "idleMs", "refreshThresholdMs", "msg", "variant", "wrapperClass", "placeholderPanel", "session", "theme", "panelHex", "panelOpacity", "panelRgba", "panelStyle", "header", "user", "bot", "send", "hideHeader", "open", "openNow", "animateIn", "floatingMode", "basePanelClass", "panelClass", "panelClassWithHeader", "msgs", "messagesHtml", "isUser", "isLast", "bubbleStyle", "formatMessageHtml", "escapeHtml", "rows", "type", "consent", "btn", "close", "form", "e", "formEl", "fd", "lead", "messageIndex", "nextMsgs", "content", "postReply", "opts", "errText", "shouldRefresh", "isExpired", "fresh", "retry", "raw2", "nextActions2", "cleanedActions2", "friendly", "nextActions", "cleanedActions", "linkify", "escaped", "_b", "lines", "inline", "joinLines", "arr", "firstNumIdx", "l", "leadLines", "items", "tailLines", "it", "firstBulIdx"]
}
