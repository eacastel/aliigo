{
  "version": 3,
  "sources": ["../../../src/widget/v1/aliigo-widget.ts"],
  "sourcesContent": ["// src/widget/v1/aliigo-widget.ts\n\ntype Role = \"user\" | \"assistant\";\ntype Msg = { role: Role; content: string };\n\ntype Theme = {\n  headerBg?: string;   // \"#111827 #ffffff\"\n  bubbleUser?: string; // \"#2563eb #ffffff\"\n  bubbleBot?: string;  // \"#f3f4f6 #111827\"\n  sendBg?: string;     // \"#2563eb #ffffff\"\n};\n\ntype SessionPayload = {\n  token: string;\n  locale: \"en\" | \"es\";\n  brand: string;\n  slug: string;\n  theme: Theme | null;\n};\n\ntype WidgetState = {\n  open: boolean;\n  busy: boolean;\n  conversationId: string | null;\n  msgs: Msg[];\n  session: SessionPayload | null;\n  locale: \"en\" | \"es\";\n  visitorSessionId: string | null;\n};\n\nconst UI = {\n  en: {\n    pill: (brand: string) => (brand ? `Ask ${brand}` : \"Chat\"),\n    title: (brand: string) => (brand ? `${brand} Assistant` : \"Assistant\"),\n    welcome: \"Ask a question and we\u2019ll help right away.\",\n    placeholder: \"Type your question\u2026\",\n    send: \"Send\",\n  },\n  es: {\n    pill: (brand: string) => (brand ? `Pregunta a ${brand}` : \"Chat\"),\n    title: (brand: string) => (brand ? `Asistente de ${brand}` : \"Asistente\"),\n    welcome: \"Haz tu consulta y te ayudamos al momento.\",\n    placeholder: \"Escribe tu consulta\u2026\",\n    send: \"Enviar\",\n  },\n} as const;\n\nfunction isEs(locale: string) {\n  return (locale || \"\").toLowerCase().startsWith(\"es\");\n}\n\nfunction splitPair(v?: string, defaults?: { bg: string; text: string }) {\n  const s = (v || \"\").trim();\n  const m = s.match(/#([0-9a-fA-F]{3}){1,2}/g) || [];\n  const bg = m[0] || defaults?.bg || \"#111827\";\n  const text = m[1] || defaults?.text || \"#ffffff\";\n  return { bg, text };\n}\n\nclass AliigoWidget extends HTMLElement {\n  private root!: ShadowRoot;\n\n  private STORAGE_TTL_MS = 30 * 60 * 1000;\n  private STORAGE_PREFIX = \"aliigo_widget_v1\";\n\n  private pendingScroll: \"bottom\" | \"lastAssistantStart\" | null = null;\n\n  // TTL enforcement even without page refresh\n  private expiryTimer: number | null = null;\n  private lastActiveAtMs: number | null = null;\n\n  private onFocus = () => this.checkExpiryNow();\n  private onVis = () => {\n    if (!document.hidden) this.checkExpiryNow();\n  };\n\n  private state: WidgetState = {\n    open: false,\n    busy: false,\n    conversationId: null,\n    msgs: [],\n    session: null,\n    locale: \"en\",\n    visitorSessionId: null,\n  };\n\n  static get observedAttributes() {\n    return [\n      \"variant\", \"embed-key\", \"api-base\", \"locale\", \"session-token\",\n      \"floating-mode\", \"theme\", \"brand\",\n      \"start-open\",\n    ];\n  }\n\n  private ensureRoot() {\n    if (!this.shadowRoot) {\n      this.root = this.attachShadow({ mode: \"open\" });\n    } else {\n      this.root = this.shadowRoot;\n    }\n  }\n\n  connectedCallback() {\n    this.ensureRoot();\n    this.state.visitorSessionId = this.getOrCreateVisitorSessionId();\n\n    // restore transcript + conversationId (if within TTL)\n    this.loadPersisted();\n\n    // If we have recent persisted messages, auto-open on refresh (floating only)\n    if (this.getVariant() === \"floating\" && this.state.msgs.length > 0) {\n      this.state.open = true;\n      this.pendingScroll = \"bottom\";\n    }\n\n    // If client embed (fixed mode), move to <body> so it's truly viewport-fixed.\n    if (this.getVariant() === \"floating\" && this.getFloatingMode() === \"fixed\") {\n      const host = document.body;\n      if (this.parentElement !== host) host.appendChild(this);\n    }\n\n    if (this.getVariant() === \"floating\" && this.getStartOpen()) {\n      this.state.open = true;\n      this.pendingScroll = \"bottom\";\n    }\n\n    // Enforce TTL even when the tab stays open\n    window.addEventListener(\"focus\", this.onFocus);\n    document.addEventListener(\"visibilitychange\", this.onVis);\n    this.scheduleExpiryTimer();\n\n    this.render();\n    void this.ensureSession();\n  }\n\n  disconnectedCallback() {\n    window.removeEventListener(\"focus\", this.onFocus);\n    document.removeEventListener(\"visibilitychange\", this.onVis);\n    this.clearExpiryTimer();\n  }\n\n  attributeChangedCallback(name: string, oldValue: string | null, newValue: string | null) {\n    if (oldValue === newValue) return;\n\n    // attributeChangedCallback can run before connectedCallback\n    this.ensureRoot();\n\n    // Always rerender\n    this.render();\n\n    // Only refetch session if these change\n    if (name === \"embed-key\" || name === \"api-base\" || name === \"session-token\") {\n      this.state.session = null; // force refresh\n      void this.ensureSession();\n    }\n  }\n\n  private clearExpiryTimer() {\n    if (this.expiryTimer != null) {\n      window.clearTimeout(this.expiryTimer);\n      this.expiryTimer = null;\n    }\n  }\n\n  private scheduleExpiryTimer() {\n    this.clearExpiryTimer();\n\n    // Only enforce TTL if we have a conversation transcript to expire\n    if (!this.lastActiveAtMs || this.state.msgs.length === 0) return;\n\n    const msLeft = this.lastActiveAtMs + this.STORAGE_TTL_MS - Date.now();\n    if (msLeft <= 0) {\n      this.expireConversation();\n      return;\n    }\n\n    // Add a tiny buffer so we don't race exact millisecond boundaries\n    this.expiryTimer = window.setTimeout(() => {\n      this.checkExpiryNow();\n    }, msLeft + 50);\n  }\n\n  private checkExpiryNow() {\n    if (!this.lastActiveAtMs || this.state.msgs.length === 0) return;\n\n    const idleMs = Date.now() - this.lastActiveAtMs;\n    if (idleMs >= this.STORAGE_TTL_MS) {\n      this.expireConversation();\n    } else {\n      this.scheduleExpiryTimer();\n    }\n  }\n\n  private expireConversation() {\n    // Clear persisted transcript and reset in-memory conversation\n    this.clearPersisted();\n    this.lastActiveAtMs = null;\n    this.clearExpiryTimer();\n\n    this.state.msgs = [];\n    this.state.conversationId = null;\n    this.state.busy = false;\n\n    // For floating widgets, close on expiry\n    if (this.getVariant() === \"floating\") {\n      this.state.open = false;\n    }\n\n    this.render();\n  }\n\n  private applyPendingScroll() {\n    const messages = this.root.querySelector(\".messages\") as HTMLDivElement | null;\n    if (!messages || !this.pendingScroll) return;\n\n    const mode = this.pendingScroll;\n    this.pendingScroll = null;\n\n    requestAnimationFrame(() => {\n      const max = Math.max(0, messages.scrollHeight - messages.clientHeight);\n\n      if (mode === \"bottom\") {\n        messages.scrollTop = max;\n        return;\n      }\n\n      // lastAssistantStart => jump to last assistant message top (with a little offset)\n      for (let i = this.state.msgs.length - 1; i >= 0; i--) {\n        if (this.state.msgs[i]?.role === \"assistant\") {\n          const el = this.root.querySelector(`#msg-${i}`) as HTMLElement | null;\n          if (!el) return;\n\n          const desired = el.offsetTop - 12;\n          messages.scrollTop = Math.max(0, Math.min(desired, max));\n          return;\n        }\n      }\n    });\n  }\n\n  private getOrCreateVisitorSessionId() {\n    const k = \"aliigo_visitor_session_v1\";\n    try {\n      const existing = localStorage.getItem(k);\n      if (existing && existing.length >= 24) return existing;\n\n      const rnd = crypto.getRandomValues(new Uint8Array(16));\n      const id = Array.from(rnd).map((b) => b.toString(16).padStart(2, \"0\")).join(\"\");\n      localStorage.setItem(k, id);\n      return id;\n    } catch {\n      // last resort (no storage): per-page random\n      return `${Date.now()}_${Math.random().toString(16).slice(2)}`;\n    }\n  }\n\n  private storageKey() {\n    // embed-key is stable for real embeds; session-token covers dashboard preview\n    const embedKey = this.getEmbedKey();\n    const overrideToken = this.getSessionTokenOverride();\n    const host = (window.location.hostname || \"\").toLowerCase();\n    const key = embedKey || overrideToken || \"no-key\";\n    return `${this.STORAGE_PREFIX}:${key}:${host}`;\n  }\n\n  private loadPersisted() {\n    try {\n      const raw = localStorage.getItem(this.storageKey());\n      if (!raw) return;\n\n      const parsed = JSON.parse(raw) as {\n        savedAt?: number;\n        lastActiveAt?: number;\n        open?: boolean;\n        conversationId?: string | null;\n        msgs?: Msg[];\n        locale?: \"en\" | \"es\";\n      };\n\n      const lastActive =\n        typeof parsed.lastActiveAt === \"number\"\n          ? parsed.lastActiveAt\n          : typeof parsed.savedAt === \"number\"\n            ? parsed.savedAt\n            : 0;\n\n      if (!lastActive || Date.now() - lastActive > this.STORAGE_TTL_MS) {\n        this.clearPersisted();\n        return;\n      }\n\n      if (typeof parsed.open === \"boolean\") this.state.open = parsed.open;\n      if (Array.isArray(parsed.msgs)) this.state.msgs = parsed.msgs;\n      if (typeof parsed.conversationId === \"string\") this.state.conversationId = parsed.conversationId;\n      if (parsed.locale === \"en\" || parsed.locale === \"es\") this.state.locale = parsed.locale;\n\n      // Track last active for live TTL expiry\n      if (this.state.msgs.length > 0) {\n        this.lastActiveAtMs = lastActive || Date.now();\n      }\n    } catch {\n      // ignore\n    }\n  }\n\n  private savePersisted(touch: boolean = true) {\n    try {\n      const k = this.storageKey();\n      const now = Date.now();\n\n      // Preserve original savedAt if it exists\n      let savedAt = now;\n\n      // Preserve previous lastActiveAt if touch=false\n      let prevLastActiveAt: number | undefined = undefined;\n\n      try {\n        const prevRaw = localStorage.getItem(k);\n        if (prevRaw) {\n          const prev = JSON.parse(prevRaw) as { savedAt?: number; lastActiveAt?: number };\n          if (typeof prev.savedAt === \"number\") savedAt = prev.savedAt;\n          if (typeof prev.lastActiveAt === \"number\") prevLastActiveAt = prev.lastActiveAt;\n        }\n      } catch {\n        // ignore parse issues\n      }\n\n      const nextLastActiveAt = touch ? now : prevLastActiveAt;\n\n      const payload = {\n        savedAt,\n        lastActiveAt: nextLastActiveAt,\n        conversationId: this.state.conversationId,\n        msgs: this.state.msgs,\n        locale: this.state.locale,\n        open: this.state.open,\n      };\n\n      localStorage.setItem(k, JSON.stringify(payload));\n\n      // update live TTL tracking\n      if (this.state.msgs.length > 0) {\n        this.lastActiveAtMs = touch ? now : (nextLastActiveAt ?? this.lastActiveAtMs);\n      } else {\n        this.lastActiveAtMs = null;\n      }\n\n      this.scheduleExpiryTimer();\n    } catch {\n      // ignore storage failures\n    }\n  }\n\n  private clearPersisted() {\n    try {\n      localStorage.removeItem(this.storageKey());\n    } catch {}\n  }\n\n  private getBrandOverride(): string | null {\n    const b = (this.getAttribute(\"brand\") || \"\").trim();\n    return b || null;\n  }\n\n  private getVariant(): \"floating\" | \"inline\" | \"hero\" {\n    const v = (this.getAttribute(\"variant\") || \"floating\").toLowerCase();\n    if (v === \"inline\" || v === \"hero\") return v;\n    return \"floating\";\n  }\n\n  private getEmbedKey() {\n    return (this.getAttribute(\"embed-key\") || \"\").trim();\n  }\n\n  private getApiBase() {\n    return (this.getAttribute(\"api-base\") || \"https://aliigo.com\").trim().replace(/\\/$/, \"\");\n  }\n\n  private getLocaleOverride(): \"en\" | \"es\" | null {\n    const v = (this.getAttribute(\"locale\") || \"\").trim().toLowerCase();\n    if (!v) return null;\n    return v.startsWith(\"es\") ? \"es\" : \"en\";\n  }\n\n  private getSessionTokenOverride(): string | null {\n    const t = (this.getAttribute(\"session-token\") || \"\").trim();\n    return t || null;\n  }\n\n  private getThemeOverride(): Theme | null {\n    const raw = (this.getAttribute(\"theme\") || \"\").trim();\n    if (!raw) return null;\n\n    try {\n      const o = JSON.parse(raw) as Partial<Theme>;\n      const out: Theme = {};\n\n      if (typeof o.headerBg === \"string\") out.headerBg = o.headerBg;\n      if (typeof o.bubbleUser === \"string\") out.bubbleUser = o.bubbleUser;\n      if (typeof o.bubbleBot === \"string\") out.bubbleBot = o.bubbleBot;\n      if (typeof o.sendBg === \"string\") out.sendBg = o.sendBg;\n\n      return out;\n    } catch {\n      return null;\n    }\n  }\n\n  private getStartOpen(): boolean {\n    return (this.getAttribute(\"start-open\") || \"\").toLowerCase() === \"true\";\n  }\n\n  private getFloatingMode(): \"fixed\" | \"absolute\" {\n    const v = (this.getAttribute(\"floating-mode\") || \"\").toLowerCase();\n    return v === \"absolute\" ? \"absolute\" : \"fixed\";\n  }\n\n  private async ensureSession(): Promise<SessionPayload | null> {\n    const overrideToken = this.getSessionTokenOverride();\n    const embedKey = this.getEmbedKey();\n    if (!embedKey && !overrideToken) return null;\n\n    // If we already have a session and it's still compatible with overrides, don\u2019t thrash\n    if (this.state.session && !overrideToken) return this.state.session;\n\n    try {\n      const apiBase = this.getApiBase();\n\n      if (overrideToken) {\n        const localeOverride = this.getLocaleOverride();\n        const themeOverride = this.getThemeOverride();\n        const brandOverride = this.getBrandOverride();\n\n        this.state.session = {\n          token: overrideToken,\n          locale: localeOverride || this.state.locale,\n          brand: (brandOverride || \"\").trim(),\n          slug: \"\",\n          theme: themeOverride,\n        };\n\n        this.state.locale = localeOverride || this.state.locale;\n        this.savePersisted(false);\n        this.render();\n        return this.state.session;\n      }\n\n      const url = new URL(`${apiBase}/api/embed/session`);\n      url.searchParams.set(\"key\", embedKey);\n      url.searchParams.set(\"host\", window.location.hostname);\n\n      const res = await fetch(url.toString(), { method: \"GET\" });\n      const data = (await res.json().catch(() => ({}))) as Partial<SessionPayload> & { error?: string };\n\n      if (!res.ok || !data.token) {\n        this.state.session = null;\n        this.renderError(data.error || \"Session error\");\n        return null;\n      }\n\n      const localeOverride = this.getLocaleOverride();\n      const locale = localeOverride || (isEs(data.locale || \"en\") ? \"es\" : \"en\");\n\n      this.state.session = {\n        token: data.token,\n        locale,\n        brand: (data.brand || \"\").trim(),\n        slug: (data.slug || \"\").trim(),\n        theme: (data.theme as Theme | null) || null,\n      };\n\n      this.state.locale = locale;\n      this.savePersisted(false);\n      this.render();\n      return this.state.session;\n    } catch {\n      this.renderError(\"Network error\");\n      return null;\n    }\n  }\n\n  private async tryRefreshSessionToken(): Promise<string | null> {\n    this.state.session = null;\n    const s = await this.ensureSession();\n    return s?.token ?? null;\n  }\n\n  private renderError(msg: string) {\n    this.ensureRoot();\n    this.root.innerHTML = `\n      <style>${this.css()}</style>\n      <div class=\"wrap inline\">\n        <div class=\"panel\">\n          <div class=\"header\">Aliigo</div>\n          <div class=\"body\"><div class=\"bubble bot\">${msg}</div></div>\n        </div>\n      </div>\n    `;\n  }\n\n  private css() {\n    return `\n      :host { all: initial; display: block; }\n      :host([floating-mode=\"absolute\"]) { position: relative; width: 100%; height: 100%; display: block; }\n\n      .wrap {\n        font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, Helvetica, Arial, sans-serif, \"Apple Color Emoji\", \"Segoe UI Emoji\";\n        box-sizing: border-box;\n        -webkit-font-smoothing: antialiased;\n      }\n      .wrap * { box-sizing: border-box; }\n\n      /* --- Positioning --- */\n      .floating.fixed {\n        position: fixed;\n        right: 20px;\n        bottom: 20px;\n        z-index: 99999;\n      }\n      .floating.absolute {\n        position: absolute;\n        inset: 0;\n        z-index: 99999;\n        display: flex;\n        justify-content: flex-end;\n        align-items: flex-end;\n        padding: 20px;\n      }\n      .floating.absolute .panel {\n        max-width: 100%;\n        max-height: 100%;\n      }\n      .inline { width: 100%; }\n      .hero { width: 100%; height: 100%; max-width: 100%; margin: 0 auto; }\n\n      /* --- Pill (Launcher) --- */\n      .pill {\n        border: 0; cursor: pointer; font-weight: 600;\n        border-radius: 99px; padding: 14px 24px;\n        box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n        transition: transform 0.2s ease, box-shadow 0.2s ease;\n        font-size: 15px;\n        display: flex; align-items: center; gap: 8px;\n      }\n      .pill:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.2); }\n      .pill:active { transform: translateY(0); }\n\n      /* --- Main Panel --- */\n      .panel {\n        width: 380px;\n        height: 600px;\n        max-height: 80vh;\n        background: #ffffff;\n        border: 1px solid rgba(0,0,0,0.06);\n        border-radius: 16px;\n        overflow: hidden;\n        box-shadow: 0 8px 32px rgba(0,0,0,0.12);\n        display: flex;\n        flex-direction: column;\n        animation: panel-enter 0.3s cubic-bezier(0.16, 1, 0.3, 1);\n      }\n\n      .panel.inline { width: 100%; max-width: 100%; height: 500px; box-shadow: none; border: 1px solid #e5e7eb; }\n      .panel.hero { width: 100%; max-width: 100%; height: 100%; box-shadow: none; border: none; border-radius: 0; }\n\n      /* --- Header --- */\n      .header {\n        padding: 16px 20px;\n        display: flex; align-items: center; justify-content: space-between;\n        border-bottom: 1px solid rgba(0,0,0,0.05);\n        font-weight: 600;\n        font-size: 16px;\n        letter-spacing: -0.01em;\n      }\n      .close {\n        border: 0; background: transparent; cursor: pointer;\n        font-size: 24px; line-height: 1; opacity: 0.6;\n        padding: 4px; margin: -4px;\n        transition: opacity 0.2s;\n      }\n      .close:hover { opacity: 1; }\n\n      /* --- Body & Messages --- */\n      .body {\n        flex: 1;\n        min-height: 0;\n        position: relative;\n        background-color: #ffffff;\n      }\n      .messages {\n        height: 100%;\n        overflow-y: auto;\n        overflow-x: hidden;\n        padding: 20px;\n        scroll-behavior: smooth;\n      }\n\n      .row {\n        margin-top: 12px;\n        display: flex;\n        width: 100%;\n      }\n      .row.user { justify-content: flex-end; }\n      .row.bot { justify-content: flex-start; }\n\n      /* --- Bubbles --- */\n      .bubble {\n        display: block;\n        position: relative;\n        max-width: 85%;\n        padding: 10px 16px;\n        border-radius: 18px;\n        font-size: 15px;\n        line-height: 1.5;\n        word-wrap: break-word;\n        white-space: normal;\n        box-shadow: 0 1px 2px rgba(0,0,0,0.04);\n        animation: message-enter 0.3s cubic-bezier(0.25, 1, 0.5, 1) forwards;\n        transform-origin: bottom center;\n      }\n\n      .bubble.user {\n        border-bottom-right-radius: 4px;\n        margin-left: 40px;\n      }\n\n      .bubble.bot {\n        border-bottom-left-radius: 4px;\n        margin-right: 40px;\n        border: 1px solid rgba(0,0,0,0.04);\n      }\n\n      .bubble strong { font-weight: 600; }\n      .bubble .list { margin: 8px 0 0 0; padding-left: 18px; }\n      .bubble .list li { margin: 4px 0; }\n\n      /* --- Input Area --- */\n      .form {\n        flex: 0 0 auto;\n        display: flex;\n        gap: 10px;\n        padding: 16px;\n        border-top: 1px solid rgba(0,0,0,0.06);\n        background: #ffffff;\n      }\n\n      .input {\n        flex: 1;\n        height: 44px;\n        border: 1px solid #e5e7eb;\n        background: #f9fafb;\n        border-radius: 22px;\n        padding: 0 16px;\n        font-size: 15px;\n        outline: none;\n        transition: all 0.2s ease;\n        color: #111827;\n      }\n      .input:focus {\n        background: #ffffff;\n        border-color: #d1d5db;\n        box-shadow: 0 0 0 3px rgba(0,0,0,0.05);\n      }\n      .input::placeholder { color: #9ca3af; }\n\n      .send {\n        height: 44px;\n        padding: 0 20px;\n        border: 0;\n        border-radius: 22px;\n        font-size: 15px;\n        font-weight: 600;\n        cursor: pointer;\n        flex-shrink: 0;\n        transition: transform 0.1s ease, opacity 0.2s;\n      }\n      .send:active { transform: scale(0.96); }\n      .send:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }\n\n      @keyframes message-enter {\n        0% { opacity: 0; transform: translateY(10px) scale(0.98); }\n        100% { opacity: 1; transform: translateY(0) scale(1); }\n      }\n      @keyframes panel-enter {\n        0% { opacity: 0; transform: translateY(20px) scale(0.96); }\n        100% { opacity: 1; transform: translateY(0) scale(1); }\n      }\n\n      @media (max-width: 480px) {\n        .floating.fixed { left: 0; right: 0; bottom: 0; }\n        .panel { width: 100%; height: 100%; max-height: 100%; border-radius: 0; }\n        .header { padding: 12px 16px; }\n        .pill { bottom: 20px; right: 20px; }\n      }\n    `;\n  }\n\n  private render() {\n    this.ensureRoot();\n    const variant = this.getVariant();\n    const session = this.state.session;\n    const locale = this.getLocaleOverride() || this.state.locale;\n    const t = UI[locale];\n\n    const theme = this.getThemeOverride() || session?.theme || {};\n    const header = splitPair(theme.headerBg, { bg: \"#111827\", text: \"#ffffff\" });\n    const user = splitPair(theme.bubbleUser, { bg: \"#2563eb\", text: \"#ffffff\" });\n    const bot = splitPair(theme.bubbleBot, { bg: \"#f3f4f6\", text: \"#111827\" });\n    const send = splitPair(theme.sendBg, { bg: \"#2563eb\", text: \"#ffffff\" });\n\n    const brand = (this.getBrandOverride() || session?.brand || \"\").trim();\n    const open = variant !== \"floating\" ? true : this.state.open;\n\n    const floatingMode = this.getFloatingMode();\n    const wrapperClass =\n      variant === \"floating\"\n        ? `wrap floating ${floatingMode}`\n        : variant === \"hero\"\n          ? \"wrap hero\"\n          : \"wrap inline\";\n\n    const panelClass = variant === \"hero\" ? \"panel hero\" : variant === \"inline\" ? \"panel inline\" : \"panel\";\n\n    const msgs = this.state.msgs;\n    const messagesHtml =\n      msgs.length === 0\n        ? `<div class=\"row bot\" id=\"msg-0\">\n            <div class=\"bubble bot\" style=\"--bg:${bot.bg};--fg:${bot.text};background:var(--bg);color:var(--fg);\">\n              ${t.welcome}\n            </div>\n          </div>`\n        : msgs\n            .map((m, i) => {\n              const isUser = m.role === \"user\";\n              const bubbleStyle = isUser\n                ? `--bg:${user.bg};--fg:${user.text};background:var(--bg);color:var(--fg);`\n                : `--bg:${bot.bg};--fg:${bot.text};background:var(--bg);color:var(--fg);`;\n\n              return `<div class=\"row ${isUser ? \"user\" : \"bot\"}\" id=\"msg-${i}\">\n                <div class=\"bubble ${isUser ? \"user\" : \"bot\"}\" style=\"${bubbleStyle}\">\n                  ${formatMessageHtml(m.content)}\n                </div>\n              </div>`;\n            })\n            .join(\"\");\n\n    // floating closed => pill only\n    if (variant === \"floating\" && !open) {\n      const hasToken = !!session?.token || !!this.getSessionTokenOverride();\n      if (!hasToken) {\n        this.root.innerHTML = `<style>${this.css()}</style>`;\n        return;\n      }\n\n      this.root.innerHTML = `\n        <style>${this.css()}</style>\n        <div class=\"${wrapperClass}\">\n          <button class=\"pill\" style=\"background:${send.bg};color:${send.text};\">${t.pill(brand)}</button>\n        </div>\n      `;\n\n      const btn = this.root.querySelector(\".pill\") as HTMLButtonElement | null;\n      btn?.addEventListener(\"click\", () => {\n        this.state.open = true;\n        this.savePersisted(false);\n        this.pendingScroll = \"bottom\";\n        this.render();\n      });\n\n      return;\n    }\n\n    this.root.innerHTML = `\n      <style>${this.css()}</style>\n      <div class=\"${wrapperClass}\">\n        <div class=\"${panelClass}\">\n          <div class=\"header\" style=\"background:${header.bg};color:${header.text};\">\n            <div>${t.title(brand)}</div>\n            ${variant === \"floating\" ? `<button class=\"close\" aria-label=\"Close\" style=\"color:${header.text};\">\u00D7</button>` : ``}\n          </div>\n\n          <div class=\"body\">\n            <div class=\"messages\">${messagesHtml}<div id=\"bottom\"></div></div>\n          </div>\n\n          <form class=\"form\">\n            <input class=\"input\" placeholder=\"${t.placeholder}\" />\n            <button class=\"send\" type=\"submit\" style=\"background:${send.bg};color:${send.text};\" ${this.state.busy || !session?.token ? \"disabled\" : \"\"}>${t.send}</button>\n          </form>\n        </div>\n      </div>\n    `;\n\n    const close = this.root.querySelector(\".close\") as HTMLButtonElement | null;\n    close?.addEventListener(\"click\", () => {\n      this.state.open = false;\n      this.savePersisted(false);\n      this.render();\n    });\n\n    const form = this.root.querySelector(\".form\") as HTMLFormElement | null;\n    const input = this.root.querySelector(\".input\") as HTMLInputElement | null;\n\n    form?.addEventListener(\"submit\", (e) => {\n      e.preventDefault();\n      const v = (input?.value || \"\").trim();\n      if (!v) return;\n      if (input) input.value = \"\";\n      void this.send(v);\n    });\n\n    this.applyPendingScroll();\n  }\n\n  private async send(content: string) {\n    const session = this.state.session;\n    if (!session?.token) return;\n\n    this.state.busy = true;\n    this.state.msgs = [...this.state.msgs, { role: \"user\", content }];\n    this.savePersisted(true);\n    this.pendingScroll = \"bottom\";\n    this.render();\n\n    try {\n      const apiBase = this.getApiBase();\n      const res = await fetch(`${apiBase}/api/conversation`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          token: session.token,\n          conversationId: this.state.conversationId,\n          externalRef: this.state.visitorSessionId,\n          message: content,\n          locale: this.state.locale,\n          channel: \"web\",\n        }),\n      });\n\n      const raw = (await res.json().catch(() => ({}))) as {\n        conversationId?: string;\n        reply?: string;\n        error?: string;\n        locale?: string;\n      };\n\n      if (!res.ok) {\n        const errText = (raw.error || \"\").toLowerCase();\n\n        // Auto-recover from \"Session expired\" once (refresh token, retry)\n        if (res.status === 403 && errText.includes(\"session expired\")) {\n          const fresh = await this.tryRefreshSessionToken();\n\n          if (fresh) {\n            const retry = await fetch(`${apiBase}/api/conversation`, {\n              method: \"POST\",\n              headers: { \"Content-Type\": \"application/json\" },\n              body: JSON.stringify({\n                token: fresh,\n                conversationId: this.state.conversationId,\n                externalRef: this.state.visitorSessionId,\n                message: content,\n                locale: this.state.locale,\n                channel: \"web\",\n              }),\n            });\n\n            const raw2 = (await retry.json().catch(() => ({}))) as {\n              conversationId?: string;\n              reply?: string;\n              error?: string;\n              locale?: string;\n            };\n\n            if (retry.ok) {\n              if (raw2.conversationId) this.state.conversationId = raw2.conversationId;\n              this.state.msgs = [...this.state.msgs, { role: \"assistant\", content: raw2.reply || \"\" }];\n              this.state.busy = false;\n              this.savePersisted(true);\n              this.pendingScroll = \"lastAssistantStart\";\n              this.render();\n              return;\n            }\n\n            // retry failed\n            this.state.msgs = [...this.state.msgs, { role: \"assistant\", content: raw2.error || \"Error\" }];\n            this.state.busy = false;\n            this.savePersisted(true);\n            this.pendingScroll = \"lastAssistantStart\";\n            this.render();\n            return;\n          }\n        }\n\n        // default error path\n        this.state.msgs = [...this.state.msgs, { role: \"assistant\", content: raw.error || \"Error\" }];\n        this.state.busy = false;\n        this.savePersisted(true);\n        this.pendingScroll = \"lastAssistantStart\";\n        this.render();\n        return;\n      }\n\n      if (raw.conversationId) this.state.conversationId = raw.conversationId;\n      this.state.msgs = [...this.state.msgs, { role: \"assistant\", content: raw.reply || \"\" }];\n      this.state.busy = false;\n      this.savePersisted(true);\n      this.pendingScroll = \"lastAssistantStart\";\n      this.render();\n    } catch {\n      this.state.msgs = [...this.state.msgs, { role: \"assistant\", content: \"Network error\" }];\n      this.pendingScroll = \"lastAssistantStart\";\n      this.state.busy = false;\n      this.savePersisted(true);\n      this.render();\n    }\n  }\n}\n\nfunction escapeHtml(s: string) {\n  return (s || \"\")\n    .replaceAll(\"&\", \"&amp;\")\n    .replaceAll(\"<\", \"&lt;\")\n    .replaceAll(\">\", \"&gt;\")\n    .replaceAll('\"', \"&quot;\")\n    .replaceAll(\"'\", \"&#039;\");\n}\n\nfunction formatMessageHtml(raw: string) {\n  const escaped = escapeHtml(raw || \"\");\n  const lines = escaped.split(/\\r?\\n/);\n\n  const inline = (s: string) =>\n    s.replace(/\\*\\*(.+?)\\*\\*/g, \"<strong>$1</strong>\");\n\n  const joinLines = (arr: string[]) => inline(arr.join(\"<br/>\"));\n\n  // ---------- Numbered list ----------\n  const firstNumIdx = lines.findIndex((l) => /^\\s*\\d+\\.\\s+/.test(l));\n  if (firstNumIdx !== -1) {\n    const leadLines = lines.slice(0, firstNumIdx).filter((l) => l.trim() !== \"\");\n\n    const items: string[] = [];\n    const tailLines: string[] = [];\n\n    for (let i = firstNumIdx; i < lines.length; i++) {\n      const l = lines[i] ?? \"\";\n      if (/^\\s*\\d+\\.\\s+/.test(l)) {\n        items.push(l.replace(/^\\s*\\d+\\.\\s+/, \"\").trim());\n        continue;\n      }\n      if (l.trim() === \"\") continue;\n      tailLines.push(l);\n    }\n\n    if (items.length === 0) return joinLines(lines);\n\n    return `\n      ${leadLines.length ? `<div class=\"lead\">${joinLines(leadLines)}</div>` : \"\"}\n      <ol class=\"list\">\n        ${items.map((it) => `<li>${inline(it)}</li>`).join(\"\")}\n      </ol>\n      ${tailLines.length ? `<div class=\"tail\">${joinLines(tailLines)}</div>` : \"\"}\n    `;\n  }\n\n  // ---------- Bulleted list ----------\n  const firstBulIdx = lines.findIndex((l) => /^\\s*[-\u2022]\\s+/.test(l));\n  if (firstBulIdx !== -1) {\n    const leadLines = lines.slice(0, firstBulIdx).filter((l) => l.trim() !== \"\");\n\n    const items: string[] = [];\n    const tailLines: string[] = [];\n\n    for (let i = firstBulIdx; i < lines.length; i++) {\n      const l = lines[i] ?? \"\";\n      if (/^\\s*[-\u2022]\\s+/.test(l)) {\n        items.push(l.replace(/^\\s*[-\u2022]\\s+/, \"\").trim());\n        continue;\n      }\n      if (l.trim() === \"\") continue;\n      tailLines.push(l);\n    }\n\n    if (items.length === 0) return joinLines(lines);\n\n    return `\n      ${leadLines.length ? `<div class=\"lead\">${joinLines(leadLines)}</div>` : \"\"}\n      <ul class=\"list\">\n        ${items.map((it) => `<li>${inline(it)}</li>`).join(\"\")}\n      </ul>\n      ${tailLines.length ? `<div class=\"tail\">${joinLines(tailLines)}</div>` : \"\"}\n    `;\n  }\n\n  // ---------- Fallback ----------\n  return joinLines(lines);\n}\n\nif (!customElements.get(\"aliigo-widget\")) {\n  customElements.define(\"aliigo-widget\", AliigoWidget);\n}\n"],
  "mappings": "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",
  "names": ["UI", "brand", "isEs", "locale", "splitPair", "v", "defaults", "m", "bg", "text", "AliigoWidget", "host", "name", "oldValue", "newValue", "msLeft", "messages", "mode", "_a", "max", "i", "el", "desired", "k", "existing", "rnd", "id", "b", "embedKey", "overrideToken", "key", "raw", "parsed", "lastActive", "touch", "now", "savedAt", "prevLastActiveAt", "prevRaw", "prev", "nextLastActiveAt", "payload", "o", "out", "apiBase", "localeOverride", "themeOverride", "brandOverride", "url", "res", "data", "s", "msg", "variant", "session", "t", "theme", "header", "user", "bot", "send", "open", "floatingMode", "wrapperClass", "panelClass", "msgs", "messagesHtml", "isUser", "bubbleStyle", "formatMessageHtml", "btn", "close", "form", "input", "e", "content", "errText", "fresh", "retry", "raw2", "escapeHtml", "_b", "lines", "inline", "joinLines", "arr", "firstNumIdx", "l", "leadLines", "items", "tailLines", "it", "firstBulIdx"]
}
